{% extends 'base.html' %}
{% block content %}
    
    <h1>{{ trip.trip_name }}: All the Searchings!</h1>

    <h3>Flight Search</h3>

    <form id="flight_search">
        <label>
            Where do you want to go?<input id="destination-airport-code" type="text" name="destination" value="e.g. SFO">
        </label>
        Remember to validate that this airport doesn't match any of the origin airports
        <br>
        <label>
            When do you want to depart?<input id="depart-date" type="text" name="depart_date" value="e.g. 2016-06-11">
        </label>
        <br>
        <label>
            When are you coming back?<input id="return-date" type="text" name="return_date" value="e.g. 2016-06-21">
        </label>
        <br>
        <button type="button" id="qpx-query" data-origins='{{ origin_airport_codes }}'>Search</button>
    </form>

    <div id="finished_query"></div>
    <br>
    <div id="flightResults"></div>
    <br>

    <a href="/trip/{{ trip.trip_id }}">Back to {{ trip.trip_name }}!</a>

    <script type="text/javascript">

        function tableResults(flights) {
            $("#flightResults").append("<p>Flight ID: " + flights[0]["flight_id"] + 
                                       "</p><p>Flight Price: " + flights[0]["flight_price"] + "</p>");
            var results_table = "<table>"

            results_table += ("<thead><th>" + 
                        "<td>Origin Airport</td>" + 
                        "<td>Departure Datetime</td>" + 
                        "<td>Destination Airport</td>" + 
                        "<td>Arrival Time</td>" + 
                        "<td>Flight ID</td>" + 
                        "<td>Flight Duration</td>" + 
                        "</th></thead><tbody>");
            for (i=0; i<flights[1].length; i++) {
                var origin_airport_code = flights[1][i]["origin_airport_code"];
                var departure_datetime = flights[1][i]["departure_datetime"];
                var destination_airport_code = flights[1][i]["destination_airport_code"];
                var arrival_datetime = flights[1][i]["arrival_datetime"];
                var leg_airline = flights[1][i]["leg_airline"];
                var leg_flight_code = flights[1][i]["leg_flight_code"];
                var leg_duration = flights[1][i]["leg_duration"];
                results_table += ("<tr><td>" + origin_airport_code + 
                             "</td><td>" + departure_datetime +
                             "</td><td>" + destination_airport_code + 
                             "</td><td>" + arrival_datetime + 
                             "</td><td>" + leg_airline + leg_flight_code + 
                             "</td><td>" + leg_duration + 
                             "</td></tr>");
            }
            results_table += "</tbody></table>";
            $("#flightResults").append(results_table);
        }

        function showFlightResults(result) {
            var flights = result["flights"];
            // debugger;
            tableResults(flights);
            $("#finished_query").text("Results complete.");
        }
        
        function searchQPX(evt) {

            var optionAttributes = {
                "destination" : $("#destination-airport-code").val(),
                "depart-date" : $("#depart-date").val(),
                "return-date" : $("#return-date").val(),
            };

            $.ajax({type: "POST",
                url: "/trip/{{ trip.trip_id }}/search.json",
                data: optionAttributes,
                success: function (result) {
                    debugger;
                         alert("option added");

                         for (var i=0; i<$("#qpx-query").data("origins").length; i++) {

                              // var originAirports = $(this).data("origins").split(",")
                                // debugger;
                              var queryInputs = {
                                  "destination" : $("#destination-airport-code").val(),
                                  "depart-date" : $("#depart-date").val(),
                                  "return-date" : $("#return-date").val(),
                                  "origin-airport-code" : $("#qpx-query").data("origins")[i],
                                  "option-id" : result["option_id"],
                              };

                              $.ajax({type: "POST",
                                  url: "/trip/{{ trip.trip_id }}/results.json",
                                  data: queryInputs,
                                  success: showFlightResults,
                               });
                            }
                }
            });
        }

        $("#qpx-query").click(searchQPX);
        
    </script>

{% endblock %}

