{% extends 'base.html' %}
{% block head_stuff %}
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        width: 60%;
      }
    </style>
{% endblock %}

{% block content %}
    
    <h1 id="trip-info" data-trip="{{ trip.trip_name }}">{{ trip.trip_name }}: All the Searchings!</h1>

    <h3>Flight Search</h3>

    <a href="/untitled">blahblahblah</a>

    <form id="flight_search">
      {% if option %}
        <label>
            Where do you want to go?<input id="destination-airport-code-reQ" type="text" name="destination" value="{{ option.destination_airport_code }}" autocomplete="off" maxlength="3">
        </label>
        Remember to validate that this airport doesn't match any of the origin airports
        <br>
        <label>
            When do you want to depart?<input id="depart-date-reQ" type="text" name="depart_date" value="{{ option.depart_date }}" autocomplete="off">
        </label>
        <br>
        <label>
            When are you coming back?<input id="return-date-reQ" type="text" name="return_date" value="{{ option.return_date }}" autocomplete="off">
        </label>
        <br>
        <button type="button" id="qpx-reQuery" data-origins='{{ origin_airport_codes }}' data-option="{{ option.option_id }}" data-trip='{{ trip.trip_id }}'> Update search</button>
      {% else %}
        <label>
            Where do you want to go? Pick a destination or place marker in map below.<input id="destination-airport-code" type="text" name="destination" autocomplete="off" maxlength="3">
        </label>
        Remember to validate that this airport doesn't match any of the origin airports
        <br>
        <label>
            When do you want to depart?<input id="depart-date" type="text" name="depart_date" autocomplete="off">
        </label>
        <br>
        <label>
            When are you coming back?<input id="return-date" type="text" name="return_date" autocomplete="off">
        </label>
        <br>
        <button type="button" id="qpx-query" data-origins='{{ origin_airport_codes }}' data-trip='{{ trip.trip_id }}'>Search</button>
        {% endif %}
    </form>

    <div id="map"></div>

    <div id="finished_query"></div>
    <br>
    <div id="flightResults"></div>
    <br>

    <a href="/trip/{{ trip.trip_id }}">Back to {{ trip.trip_name }}!</a>


    <script type="text/javascript">
        $(function() {
            $('#datepicker').datepicker({
              inline: true,
              showOtherMonths: true,
              dayNamesMin: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            });
        });

        $("#depart-date-reQ").datepicker({dateFormat: "yy-mm-dd"});
        $("#depart-date").datepicker({dateFormat: "yy-mm-dd"});
        $("#return-date-reQ").datepicker({dateFormat: "yy-mm-dd"});
        $("#return-date").datepicker({dateFormat: "yy-mm-dd"});



  ////////////////////////////////////////////////////////////////////////////////

  //Next Function

  ////////////////////////////////////////////////////////////////////////////////

        $.get("/get-airports-to-autocomplete", function(result) {

            // alert(result["airports"]);
            var airportsAutocomplete = [];
            for (i=0; i<result["airports"].length; i++) {
                var airportAutocomplete = result["airports"][i][0];
                airportsAutocomplete.push(airportAutocomplete);
                // console.log(result["airports"][i][1])
            }
            // debugger;


            $("#destination-airport-code-reQ").autocomplete({
                source: function(request, response) {
                    var filteredAirportsAutocomplete = $.map(airportsAutocomplete, function(item) {
                        if(item.indexOf(request.term.toUpperCase()) == 0){
                            return item;
                        }
                        else{
                            return null;
                        }
                    });
                    response(filteredAirportsAutocomplete);
                },
                change: function () {
                    for (i=0; i<result["airports"].length; i++) {
                        if ($("#destination-airport-code").val() === result["airports"][i][0]){
                            var latitude = result["airports"][i][1][0];
                            var longitude = result["airports"][i][1][1];
                        }
                    }

                    var marker = new google.maps.Marker({
                        position: {lat: latitude, lng: longitude},
                        map: map,
                        title: "Destination"
                    });
                }   
            });

            //Add update marker function in these functions

            $("#destination-airport-code").autocomplete({
                source: function(request, response) {
                    var filteredAirportsAutocomplete = $.map(airportsAutocomplete, function(item) {
                        if(item.indexOf(request.term.toUpperCase()) == 0){
                            return item;
                        }
                        else{
                            return null;
                        }
                    });
                    response(filteredAirportsAutocomplete);
                },
                change: function () {
                    for (i=0; i<result["airports"].length; i++) {
                        if ($("#destination-airport-code").val() === result["airports"][i][0]){
                            var latitude = result["airports"][i][1][0];
                            var longitude = result["airports"][i][1][1];
                        }
                    }

                    var marker = new google.maps.Marker({
                        position: {lat: latitude, lng: longitude},
                        map: map,
                        title: "Destination"
                    });
                }   
            });

        }); 

        var map;
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 30, lng: 0},
            zoom: 2
            });

            $.get("/origins-for-map", {"trip": $("#trip-info").data("trip")}, function(result) {
                debugger;
                for (i=0; i<result["latlongs"].length; i++) {
                    var origin_lat = result["latlongs"][i][0]
                    var origin_long = result["latlongs"][i][1]
                    marker = new google.maps.Marker({
                        position: {lat: origin_lat, lng: origin_long},
                        map: map,
                        title: "Origin"
                    });
                }
            });
        }

        // $("#destination-airport-code").change(function () {
        //     debugger;
        //     for (i=0; i<result["airports"].length; i++) {
        //         if ($("#destination-airport-code").val() === result["airports"][i][0]){
        //             var latitude = result["airports"][i][1][0];
        //             var longitude = result["airports"][i][1][1];
        //         }
        //     }

        //     var marker = new google.maps.Marker({
        //         position: {lat: latitude, lng: longitude},
        //         map: map,
        //         title: 'Hello World!'
        //     });
        // });

        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-GCR38Gz0Y-tued81BwisFBmiWMtP8oU&callback=initMap"
        async defer></script>

        <script type="text/javascript">
      var tripId = $("#qpx-query").data("trip");

      var reQTripId = $("#qpx-reQuery").data("trip");

      function tableResults(flights) {
          $("#flightResults").append("<p>Flight ID: " + flights[0]["flight_id"] + 
                                     "</p><p>Flight Price: " + flights[0]["flight_price"] + "</p>");
          var results_table = "<table><thead><th>" + 
                      "<td>Origin Airport</td>" + 
                      "<td>Departure Datetime</td>" + 
                      "<td>Destination Airport</td>" + 
                      "<td>Arrival Time</td>" + 
                      "<td>Flight ID</td>" + 
                      "<td>Flight Duration</td>" + 
                      "</th></thead><tbody>";
          for (i=0; i<flights[1].length; i++) {
              var origin_airport_code = flights[1][i]["origin_airport_code"];
              var departure_datetime = flights[1][i]["departure_datetime"];
              var destination_airport_code = flights[1][i]["destination_airport_code"];
              var arrival_datetime = flights[1][i]["arrival_datetime"];
              var leg_airline = flights[1][i]["leg_airline"];
              var leg_flight_code = flights[1][i]["leg_flight_code"];
              var leg_duration = flights[1][i]["leg_duration"];
              results_table += ("<tr><td>" + origin_airport_code + 
                           "</td><td>" + departure_datetime +
                           "</td><td>" + destination_airport_code + 
                           "</td><td>" + arrival_datetime + 
                           "</td><td>" + leg_airline + leg_flight_code + 
                           "</td><td>" + leg_duration + 
                           "</td></tr>");
          }
          results_table += "</tbody></table>";
          $("#flightResults").append(results_table);
      }

      function showFlightResults(result) {
          var flights = result["flights"];
          // debugger;
          tableResults(flights);
      }

      function searchQPX(evt) {

          var optionAttributes = {
              "destination" : $("#destination-airport-code").val(),
              "depart-date" : $("#depart-date").val(),
              "return-date" : $("#return-date").val(),
          };

          $.ajax({type: "POST",
              url: "/trip/" + tripId + "/search.json",
              data: optionAttributes,
              success: function (result) {
                       // alert("option added");

                       for (var i=0; i<$("#qpx-query").data("origins").length; i++) {

                            // var originAirports = $(this).data("origins").split(",")
                              // debugger;
                            var queryInputs = {
                                "destination" : $("#destination-airport-code").val(),
                                "depart-date" : $("#depart-date").val(),
                                "return-date" : $("#return-date").val(),
                                "origin-airport-code" : $("#qpx-query").data("origins")[i],
                                "option-id" : result["option_id"],
                            };

                            $.ajax({type: "POST",
                                url: "/trip/" + tripId + "/results.json",
                                data: queryInputs,
                                success: showFlightResults,
                             });
                          }
              }
          });
      }

      $("#qpx-query").click(searchQPX);

      function updateSearchQPX(evt) {
        for (var i=0; i<$("#qpx-reQuery").data("origins").length; i++) {

                            // var originAirports = $(this).data("origins").split(",")
                              // debugger;
                            var queryInputs = {
                                "destination" : $("#destination-airport-code-reQ").val(),
                                "depart-date" : $("#depart-date-reQ").val(),
                                "return-date" : $("#return-date-reQ").val(),
                                "origin-airport-code" : $("#qpx-reQuery").data("origins")[i],
                                "option-id" : $("#qpx-reQuery").data("option"),
                            };

                            $.ajax({type: "POST",
                                url: "/trip/" + reQTripId + "/results.json",
                                data: queryInputs,
                                success: showFlightResults,
                             });
                          }

      }

      $("#qpx-reQuery").click(updateSearchQPX);

    </script>


{% endblock %}

